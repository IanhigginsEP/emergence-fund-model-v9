<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergence Partners Fund P&L Model v10.16</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print { .no-print { display: none !important; } }
    .collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapsible.open { max-height: 2000px; }
    .freeze-table { position: relative; }
    .freeze-table thead tr { position: sticky; top: 0; z-index: 20; }
    .freeze-table th:first-child, .freeze-table td:first-child { position: sticky; left: 0; z-index: 10; }
    .freeze-table thead th:first-child { z-index: 30; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"><p class="p-8 text-center text-gray-500">Loading modular components...</p></div>
  
  <!-- 1. Config Modules -->
  <script src="config/assumptions.js"></script>
  <script src="config/scenarios.js"></script>
  <script src="config/capital.js"></script>
  <script src="config/share-classes.js"></script>
  
  <!-- 2. Model Modules -->
  <script src="model/formatters.js"></script>
  <script src="model/engine.js"></script>
  <script src="model/summaries.js"></script>
  <script src="model/recoverables.js"></script>
  <script src="model/metrics.js"></script>
  
  <!-- 3. UI Components -->
  <script src="ui/Charts.js" type="text/babel"></script>
  <script src="ui/JCurve.js" type="text/babel"></script>
  <script src="ui/RevenueWaterfall.js" type="text/babel"></script>
  <script src="ui/ExpenseWaterfall.js" type="text/babel"></script>
  <script src="ui/MetricsPanel.js" type="text/babel"></script>
  <script src="ui/KPITable.js" type="text/babel"></script>
  <script src="ui/Controls.js" type="text/babel"></script>
  <script src="ui/Dashboard.js" type="text/babel"></script>
  <script src="ui/FundingSchedule.js" type="text/babel"></script>
  <script src="ui/PrintView.js" type="text/babel"></script>
  <script src="ui/Scenarios.js" type="text/babel"></script>
  <script src="ui/Sensitivity.js" type="text/babel"></script>
  <script src="ui/Tables.js" type="text/babel"></script>
  <script src="ui/Timeline.js" type="text/babel"></script>
  <script src="ui/Waterfall.js" type="text/babel"></script>
  <script src="ui/WhatIf.js" type="text/babel"></script>
  <script src="ui/BalanceSheet.js" type="text/babel"></script>
  <script src="ui/CapitalTab.js" type="text/babel"></script>
  <script src="ui/ShareClasses.js" type="text/babel"></script>
  
  <!-- 4. Main App Shell -->
  <script type="text/babel">
    const { useState, useMemo } = React;
    const FM = window.FundModel;
    
    function App() {
      const [tab, setTab] = useState('dashboard');
      const [scenarioKey, setScenarioKey] = useState('Base');
      const [assumptions, setAssumptions] = useState(FM.DEFAULT_ASSUMPTIONS);
      const [recoverableToggles, setRecoverableToggles] = useState({});
      
      const scenario = FM.PRESET_SCENARIOS[scenarioKey] || FM.PRESET_SCENARIOS['Base'];
      
      const baseCapital = useMemo(() => 
        FM.generateCapitalInputs(assumptions.preLaunchMonths, assumptions.projectionMonths, assumptions),
        [assumptions.preLaunchMonths, assumptions.projectionMonths, assumptions.gpOrganicM0to3, assumptions.gpOrganicM4to11, 
         assumptions.gpOrganicM12plus, assumptions.bdmCapitalStartMonth, assumptions.bdmMonthlyCapital,
         assumptions.brokerCapitalStartMonth, assumptions.brokerMonthlyCapital]
      );
      
      const capitalInputs = useMemo(() => 
        FM.applyMultipliers(baseCapital, scenario),
        [baseCapital, scenario]
      );
      
      const model = useMemo(() => {
        const result = FM.runModel(assumptions, capitalInputs, scenario.annualReturn || 1.0, scenario.bdmRevenueShare || 0);
        const summary = FM.calculateSummaries(result.months, result.startingCashUSD);
        return { ...result, summary };
      }, [assumptions, capitalInputs, scenario.annualReturn, scenario.bdmRevenueShare]);
      
      const recoverables = useMemo(() => 
        FM.calculateRecoverables ? FM.calculateRecoverables(model, recoverableToggles) : { items: [], totalRecoverable: 0 }, 
        [model, recoverableToggles]
      );
      
      const updateAssumption = (key, value) => setAssumptions(prev => ({ ...prev, [key]: value }));
      const resetScenario = () => setScenarioKey('Base');
      
      const tabs = [
        { id: 'dashboard', label: 'Dashboard' },
        { id: 'scenarios', label: 'ðŸŽ¯ Scenarios' },
        { id: 'capital', label: 'ðŸ’° Capital' },
        { id: 'shareclasses', label: 'ðŸ“‹ Share Classes' },
        { id: 'cashflow', label: 'Cash Flow' },
        { id: 'balancesheet', label: 'ðŸ“‹ Balance Sheet' },
        { id: 'charts', label: 'ðŸ“Š Charts' },
        { id: 'assumptions', label: 'Assumptions' },
        { id: 'recoverables', label: 'Recoverables' },
      ];
      
      return (
        <div className="p-4 max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow p-4 mb-4">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-2xl font-bold text-gray-800">
                  Emergence Partners Fund Model <span className="text-green-600">v10.16</span>
                  <span className="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">LP-READY</span>
                  <span className="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">SHARE CLASSES</span>
                </h1>
                <p className="text-sm text-gray-500">36-Month Projection â€¢ $367K Starting Pot â€¢ PPM Share Classes</p>
              </div>
              <div className="text-right">
                <p className="text-xs text-gray-500 uppercase">Active Scenario</p>
                <select value={scenarioKey} onChange={e => setScenarioKey(e.target.value)}
                  className="mt-1 px-3 py-2 border rounded-lg font-semibold text-blue-600 border-blue-400">
                  {Object.keys(FM.PRESET_SCENARIOS).map(key => (
                    <option key={key} value={key}>{key}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>
          
          <div className="flex gap-2 mb-4 flex-wrap no-print">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`px-4 py-2 rounded-lg font-medium text-sm transition ${
                  tab === t.id ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                } ${t.id === 'shareclasses' ? 'border-2 border-purple-300' : ''}`}>
                {t.label}
              </button>
            ))}
          </div>
          
          {tab === 'dashboard' && (
            <div className="space-y-4">
              {FM.MetricsPanel && <FM.MetricsPanel model={model} />}
              {FM.Dashboard && <FM.Dashboard model={model} scenarioName={scenarioKey} onResetScenario={resetScenario} />}
            </div>
          )}
          
          {tab === 'scenarios' && FM.Scenarios && (
            <FM.Scenarios 
              model={model}
              scenarioName={scenarioKey}
              assumptions={assumptions}
              baseCapitalInputs={baseCapital}
              onApplyPreset={setScenarioKey}
            />
          )}
          
          {tab === 'capital' && FM.CapitalTab && (
            <FM.CapitalTab assumptions={assumptions} capitalInputs={capitalInputs} onUpdate={updateAssumption} />
          )}
          
          {tab === 'shareclasses' && FM.ShareClassesTab && (
            <FM.ShareClassesTab model={model} />
          )}
          
          {tab === 'cashflow' && FM.CashflowStatement && (
            <div className="space-y-4">
              <FM.CashflowStatement model={model} />
              {FM.KPITable && <FM.KPITable model={model} />}
            </div>
          )}
          
          {tab === 'balancesheet' && FM.BalanceSheet && (
            <FM.BalanceSheet model={model} />
          )}
          
          {tab === 'charts' && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3 mb-4">
                <p className="text-sm text-gray-600">ðŸ“ˆ <strong>LP-Ready Visualizations</strong> â€” J-Curve, Revenue & Expense waterfalls</p>
              </div>
              {FM.JCurveChart && <FM.JCurveChart model={model} />}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {FM.RevenueWaterfall && <FM.RevenueWaterfall model={model} />}
                {FM.ExpenseWaterfall && <FM.ExpenseWaterfall model={model} />}
              </div>
              {FM.AUMChart && <FM.AUMChart model={model} />}
              {FM.CashChart && <FM.CashChart model={model} />}
              {FM.FounderFundingChart && <FM.FounderFundingChart model={model} />}
              {FM.Waterfall && <FM.Waterfall model={model} />}
            </div>
          )}
          
          {tab === 'assumptions' && FM.Controls && (
            <FM.Controls assumptions={assumptions} onUpdate={updateAssumption} />
          )}
          
          {tab === 'recoverables' && FM.RecoverablesPanel && (
            <FM.RecoverablesPanel recoverables={recoverables} toggles={recoverableToggles} onToggle={setRecoverableToggles} />
          )}
          
          <div className="mt-4 text-xs text-gray-400 text-center no-print">
            <span className="text-blue-600">Blue = Capital</span> | 
            <span className="text-green-600"> Green = Revenue</span> | 
            <span className="text-purple-600"> Purple = Founder Class</span> | 
            <span className="text-red-600"> Red = Expenses</span> | 
            <span className="text-amber-600"> Amber = Funding/SL</span>
          </div>
        </div>
      );
    }
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
